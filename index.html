<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestÃ£o de ComÃ©rcio - Sistema de Caixa</title>
    <style>
        /* Reset bÃ¡sico */
        * { box-sizing: border-box; }
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background: #fffdfb;
            color: #35231b;
        }

        /* Paleta: marrom principal e branco */
        :root{
            --brown-900: #4a2e23;
            --brown-700: #6b3e2d;
            --brown-500: #8b5a49;
            --bg: #fffdfb;
            --muted: #7a6a63;
            --accent: #b57f6b;
        }

        /* Container geral */
        .container {
            max-width: 1300px;
            margin: 16px auto;
            background: #ffffff;
            border-radius: 10px;
            min-height: 90vh;
            box-shadow: 0 6px 20px rgba(75,50,40,0.06);
            overflow: hidden;
        }

        /* Topbar */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            background: linear-gradient(90deg, var(--brown-900), var(--brown-700));
            color: #fff;
        }
        .topbar .title { font-size: 18px; font-weight: 600; }
        .topbar .actions { display:flex; gap:8px; align-items:center; }
        .topbar .search { background: rgba(255,255,255,0.08); border: none; padding:8px 10px; color:#fff; border-radius:6px; min-width:260px; }

        /* Layout principal em duas colunas */
        .layout {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 0;
            min-height: calc(100vh - 74px);
        }

        /* Painel esquerdo: seleÃ§Ã£o de produtos */
        .panel-left {
            padding: 18px;
            border-right: 1px solid #f0e9e6;
            background: var(--bg);
        }
        .panel-left .section-title { font-weight: 600; color: var(--brown-900); margin-bottom: 12px; }
        .search-row { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
        .search-input { flex:1; padding:10px 12px; border:1px solid #efe7e3; border-radius:8px; background:#fff; color:var(--brown-900); }
        .product-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:12px; margin-top:12px; }
        .product-card {
            background:#fff;
            border:1px solid #f0e6e2;
            border-radius:8px;
            padding:12px;
            display:flex;
            flex-direction:column;
            gap:8px;
            min-height:120px;
        }
        .product-card .name { font-weight:600; color:var(--brown-900); }
        .product-card .meta { color:var(--muted); font-size:13px; }
        .product-card .actions { margin-top:auto; display:flex; gap:8px; }
        .btn, button {
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            background: var(--brown-700);
            color: #fff;
        }
        .btn.ghost {
            background: transparent;
            border: 1px solid #f0e6e2;
            color: var(--brown-700);
        }
        .btn.small { padding:6px 8px; font-size:13px; }

        /* Painel direito: caixa / carrinho */
        .panel-right {
            padding: 18px;
            background: #fff;
            display:flex;
            flex-direction:column;
            justify-content:space-between;
        }
        .cart-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }
        .cart-list { margin-top:12px; overflow:auto; max-height:60vh; }
        .cart-item { display:flex; gap:12px; padding:10px; border-radius:8px; border:1px solid #f1e9e6; align-items:center; background:#fff; margin-bottom:8px; }
        .cart-item .info { flex:1; }
        .cart-item .qty { display:flex; gap:6px; align-items:center; }
        .totals { padding:12px; border-top:1px dashed #f0e6e2; display:flex; justify-content:space-between; align-items:center; margin-top:12px; }
        .total-amount { font-size:20px; font-weight:700; color:var(--brown-900); }
        .finalize { background: var(--brown-900); padding:10px 16px; border-radius:8px; color:#fff; font-weight:600; }

        /* Responsivo */
        @media (max-width: 1000px) {
            .layout { grid-template-columns: 1fr; }
            .panel-right { order: 2; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="title">ðŸ“¦ GestÃ£o de ComÃ©rcio â€” Caixa</div>
            <div class="actions">
                <input class="search" id="globalSearch" placeholder="Pesquisar produto, cÃ³digo..." />
                <button class="btn" onclick="criarSetor()">âž• Setor</button>
                <button class="btn ghost" onclick="criarProduto(event)">âž• Produto</button>
            </div>
        </div>
        <div id="message" style="padding:10px 18px;"></div>

        <div class="layout">
            <div class="panel-left">
                <div class="section-title">Produtos</div>
                <div class="search-row">
                    <input id="produtoBusca" class="search-input" placeholder="Pesquisar por nome, cÃ³digo ou GTIN" />
                    <button class="btn small" onclick="filtrarProdutos()">Pesquisar</button>
                </div>

                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <select id="setorFiltro" style="padding:8px;border-radius:8px;border:1px solid #efe7e3;background:#fff;">
                        <option value="">Todos os setores</option>
                    </select>
                    <button class="btn ghost small" onclick="showFavoritos()">Ver favoritos</button>
                </div>

                <div id="productGrid" class="product-grid">
                    <!-- cards preenchidos por renderProdutos() -->
                </div>
            </div>
            <div class="panel-right">
                <div>
                    <div class="cart-header">
                        <div>
                            <div style="font-weight:600;color:var(--brown-900)">Venda atual</div>
                            <div style="font-size:13px;color:var(--muted)">Adicione itens Ã  venda Ã  esquerda</div>
                        </div>
                        <div>
                            <input id="vendaBusca" class="search-input" placeholder="Buscar item..." style="min-width:220px;" />
                        </div>
                    </div>

                    <div id="vendaContainer" class="cart-list">
                        <!-- items gerados por renderVenda() -->
                    </div>
                </div>

                <div>
                    <div class="totals">
                        <div style="color:var(--muted)">Total</div>
                        <div class="total-amount" id="totalAmount">R$ 0,00</div>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
                        <button class="btn ghost" onclick="resetarDados()">Limpar</button>
                        <button class="finalize" onclick="finalizarVenda()">Finalizar venda</button>
                    </div>
                </div>
            </div>
        </div>
     </div>

    <script>
        // Database em memÃ³ria
        const db = {
            setores: [],
            produtos: [],
            saidas: [],
            nextSetor: 1,
            nextProduto: 1,
             vendaLista: []
         };

        // Salvar dados no localStorage
        function salvarDados() {
            localStorage.setItem('amgestao_db', JSON.stringify(db));
        }

        // Carregar dados do localStorage
        function carregarDados() {
            const saved = localStorage.getItem('amgestao_db');
            if (saved) {
                Object.assign(db, JSON.parse(saved));
            }
        }

        // Inicializar na carga
        window.onload = function() {
            carregarDados();
            renderSetores();
            renderProdutos();
            renderVenda();
            atualizarStatus();
        };

        function showMessage(msg, type = 'info') {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = msg;
            msgDiv.className = `status-message status-${type}`;
            msgDiv.style.display = 'block';
            setTimeout(() => msgDiv.style.display = 'none', 4000);
        }

        function renderSetores() {
            const container = document.getElementById('setoresContainer');
            const select = document.getElementById('setorProduto');

            container.innerHTML = '';
            if (!select) {
                // se o formulÃ¡rio ainda nÃ£o tem o select, apenas ignore
            }
            if (db.setores.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum setor cadastrado. Clique em "âž• Novo Setor" para adicionar.</div>';
                if (select) select.innerHTML = '<option value="">â€” Selecione um setor â€”</option>';
                atualizarStatus();
                return;
            }

            let html = '';
            for (const s of db.setores) {
                const produtosCount = db.produtos.filter(p => p.setor_id === s.id).length;
                html += `
                    <div class="setor-box">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <strong>${s.nome}</strong>
                            <small style="color:#666;margin-left:6px;">(${produtosCount})</small>
                        </div>
                        <div style="margin-top:8px;display:flex;gap:6px;">
                            <a href="setor.html?setor_id=${s.id}" target="_blank" style="text-decoration:none;">
                                <button type="button">Abrir produtos</button>
                            </a>
                            <button type="button" style="background:#dc3545;border:none;color:#fff;padding:8px 10px;border-radius:4px;" onclick="excluirSetor(${s.id})">Excluir</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;

            if (select) {
                select.innerHTML = '<option value="">â€” Selecione um setor â€”</option>' + db.setores.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');
            }
            atualizarStatus();
        }

        function excluirSetor(setorId) {
            const setor = db.setores.find(s => s.id === setorId);
            if (!setor) { showMessage('Setor nÃ£o encontrado.', 'error'); return; }

            const produtosNoSetor = db.produtos.filter(p => p.setor_id === setorId);
            if (produtosNoSetor.length > 0) {
                const confirmMsg = `O setor "${setor.nome}" possui ${produtosNoSetor.length} produto(s). Ao excluir, os produtos ficarÃ£o sem setor. Deseja continuar?`;
                if (!confirm(confirmMsg)) return;
                // desassocia produtos (mantÃ©m produtos)
                produtosNoSetor.forEach(p => { p.setor_id = null; });
            }

            db.setores = db.setores.filter(s => s.id !== setorId);
            salvarDados();
            showMessage('Setor removido.', 'success');
            renderSetores();
            renderProdutos();
        }

        function renderProdutos() {
            const tbody = document.getElementById('produtosTableBody');
            // se nÃ£o existir tabela detalhada, apenas atualiza selects
            const selectVenda = document.getElementById('vendaProdutoSelect');
            const selectCadastroSetor = document.getElementById('setorProduto');

            if (selectVenda) {
                selectVenda.innerHTML = '<option value="">â€” Selecione um produto â€”</option>' + db.produtos.map(p => {
                    return `<option value="${p.id}">${p.nome} â€” R$ ${Number(p.preco_venda).toFixed(2)} â€” ${p.vendido_por === 'peso' ? 'kg' : 'un'}</option>`;
                }).join('');
            }

            if (selectCadastroSetor) {
                selectCadastroSetor.innerHTML = '<option value="">â€” Selecione um setor â€”</option>' + db.setores.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');
            }

            // atualizar listagem principal de produtos se houver tabela
            if (tbody) {
                tbody.innerHTML = '';
                if (db.produtos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Nenhum produto cadastrado.</td></tr>';
                } else {
                    for (const p of db.produtos) {
                        const setor = db.setores.find(s => s.id === p.setor_id);
                        tbody.innerHTML += `<tr>
                            <td>${p.nome}</td>
                            <td>${p.codigo_barras || ''}</td>
                            <td>R$ ${Number(p.preco_venda).toFixed(2)}</td>
                            <td>${p.quantidade ?? 0}</td>
                            <td>${p.vendido_por === 'peso' ? 'Peso (kg)' : 'Unidade'}</td>
                            <td>${p.peso_unidade ? p.peso_unidade + ' kg' : '-'}</td>
                        </tr>`;
                    }
                }
            }
            atualizarStatus();
        }

        function criarSetor() {
            const nome = prompt('Nome do setor:');
            if (!nome) return;
            
            const novoSetor = { id: db.nextSetor++, nome };
            db.setores.push(novoSetor);
            salvarDados();
            renderSetores();
            showMessage(`âœ… Setor "${nome}" criado com sucesso!`, 'success');
        }

        function criarProduto(event) {
            event.preventDefault();
            const nome = document.getElementById('produtoNome').value.trim();
            const codigo = document.getElementById('produtoCodigo').value.trim();
            const setorId = Number(document.getElementById('setorProduto').value) || null;
            const precoCompra = parseFloat(document.getElementById('produtoPrecoCompra').value) || 0;
            const precoVenda = parseFloat(document.getElementById('produtoPrecoVenda').value) || 0;
            const quantidade = parseFloat(document.getElementById('produtoQuantidade').value) || 0;
            const vendido_por = document.getElementById('produtoTipoVenda').value || 'unidade';
            const peso_unidade = parseFloat(document.getElementById('produtoPesoUnidade').value) || null;

            const produto = {
                id: db.nextProduto++,
                nome,
                codigo_barras: codigo,
                setor_id: setorId,
                preco_compra: precoCompra,
                preco_venda: precoVenda,
                quantidade,
                vendido_por: vendido_por === 'peso' ? 'peso' : 'unidade',
                peso_unidade: peso_unidade > 0 ? peso_unidade : null
            };
            db.produtos.push(produto);
            salvarDados();
            showMessage('Produto cadastrado.', 'success');
            // limpar form
            document.getElementById('produtoNome').value = '';
            document.getElementById('produtoCodigo').value = '';
            document.getElementById('produtoPrecoCompra').value = '';
            document.getElementById('produtoPrecoVenda').value = '';
            document.getElementById('produtoQuantidade').value = 0;
            document.getElementById('produtoPesoUnidade').value = '';
            renderSetores();
            renderProdutos();
        }

        function scanVenda() {
            const sel = document.getElementById('vendaProdutoSelect');
            const produtoId = Number(sel.value);
            if (!produtoId) { showMessage('Selecione um produto', 'error'); return; }
            const produto = db.produtos.find(p => p.id === produtoId);
            if (!produto) { showMessage('Produto nÃ£o encontrado', 'error'); return; }

            const input = document.getElementById('vendaQtd');
            const valor = parseFloat(input.value);
            if (!valor || valor <= 0) { showMessage('Informe quantidade ou peso vÃ¡lido', 'error'); return; }

            // calcular total conforme tipo
            let quantidade = 0;
            let peso = null;
            if (produto.vendido_por === 'peso') {
                peso = valor; // em kg
                // opcionalmente, reduzir estoque por peso usando peso_unidade se estiver em "unidades"
            } else {
                quantidade = valor;
            }

            // adicionar Ã  lista de venda
            db.vendaLista.push({
                produtoId: produto.id,
                nome: produto.nome,
                preco_venda: produto.preco_venda,
                vendido_por: produto.vendido_por,
                quantidade: quantidade,
                peso: peso
            });

            // decrementar estoque quando aplicÃ¡vel (simples)
            if (produto.vendido_por === 'unidade') {
                produto.quantidade = Math.max(0, (produto.quantidade || 0) - quantidade);
            } else if (produto.vendido_por === 'peso' && produto.peso_unidade) {
                // se estoque for contado por unidades e peso_unidade informado, reduzir por nÃºmero de unidades equivalentes
                // caso contrÃ¡rio, nÃ£o altera quantidade (sistema simples)
                // Ex.: se peso_unidade = 0.5kg e vender 1.0kg => reduz 2 unidades
                if (produto.quantidade && produto.peso_unidade > 0) {
                    const unidades = Math.round(peso / produto.peso_unidade);
                    produto.quantidade = Math.max(0, produto.quantidade - unidades);
                }
            }

            salvarDados();
            input.value = '';
            renderVenda();
            renderProdutos();
        }

        function removerVenda(index) {
            if (index < 0 || index >= db.vendaLista.length) return;
            // restaurar estoque bÃ¡sico ao remover item (apenas para unidade simples)
            const item = db.vendaLista[index];
            const produto = db.produtos.find(p => p.id === item.produtoId);
            if (produto) {
                if (item.vendido_por === 'unidade') {
                    produto.quantidade = (produto.quantidade || 0) + (item.quantidade || 0);
                } else if (item.vendido_por === 'peso' && produto.peso_unidade && produto.quantidade !== undefined) {
                    const unidades = item.peso && produto.peso_unidade ? Math.round(item.peso / produto.peso_unidade) : 0;
                    produto.quantidade = (produto.quantidade || 0) + unidades;
                }
            }
            db.vendaLista.splice(index, 1);
            salvarDados();
            renderVenda();
            renderProdutos();
        }

        function renderVenda() {
            const container = document.getElementById('vendaContainer');
            if (!db.vendaLista || db.vendaLista.length === 0) {
                container.innerHTML = '<div class="empty-state">Carrinho vazio.</div>';
                atualizarStatus();
                return;
            }
            let html = '<table><thead><tr><th>Produto</th><th>Tipo</th><th>Quantidade / Peso</th><th>PreÃ§o Unit.</th><th>Total</th><th></th></tr></thead><tbody>';
            let soma = 0;
            db.vendaLista.forEach((it, idx) => {
                const total = it.vendido_por === 'peso' ? (it.preco_venda * (it.peso || 0)) : (it.preco_venda * (it.quantidade || 0));
                soma += total;
                html += `<tr>
                    <td>${it.nome}</td>
                    <td>${it.vendido_por === 'peso' ? 'Kg' : 'Un'}</td>
                    <td>${it.vendido_por === 'peso' ? (it.peso || 0) + ' kg' : (it.quantidade || 0)}</td>
                    <td>R$ ${Number(it.preco_venda).toFixed(2)}</td>
                    <td>R$ ${Number(total).toFixed(2)}</td>
                    <td><button onclick="removerVenda(${idx})">Remover</button></td>
                </tr>`;
            });
            html += `</tbody></table><div style="text-align:right;margin-top:8px;"><strong>Total: R$ ${soma.toFixed(2)}</strong> <button onclick="finalizarVenda()" class="success" style="margin-left:12px;">Finalizar Venda</button></div>`;
            container.innerHTML = html;
            atualizarStatus();
        }

        function finalizarVenda() {
            if (db.vendaLista.length === 0) {
                showMessage('âŒ Nenhum produto na venda', 'error');
                return;
            }

            for (const item of db.vendaLista) {
                const produto = db.produtos.find(p => p.id === item.id);
                if (produto) {
                    if (produto.quantidade < item.quantidade) {
                        showMessage(`âŒ Quantidade insuficiente de ${produto.nome}`, 'error');
                        return;
                    }
                    produto.quantidade -= item.quantidade;
                    db.saidas.push({
                        id: db.saidas.length + 1,
                        produto_id: item.id,
                        quantidade: item.quantidade,
                        data: new Date().toISOString(),
                        codigo_barras: item.codigo_barras
                    });
                }
            }

            const total = db.vendaLista.reduce((sum, item) => sum + (item.preco_venda * item.quantidade), 0);
            showMessage(`âœ… Venda de R$ ${total.toFixed(2)} registrada com sucesso!`, 'success');
            
            db.vendaLista = [];
            salvarDados();
            renderVenda();
            atualizarStatus();
            document.getElementById('codigoVenda').focus();
        }

        function calcularLucro() {
            let totalLucro = 0;
            for (const saida of db.saidas) {
                const produto = db.produtos.find(p => p.id === saida.produto_id);
                if (produto) {
                    const lucroUnitario = produto.preco_venda - produto.preco_compra;
                    totalLucro += lucroUnitario * saida.quantidade;
                }
            }
            showMessage(`ðŸ’¹ Lucro Total: R$ ${totalLucro.toFixed(2)}`, 'info');
        }

        function relatorioVendas() {
            if (db.saidas.length === 0) {
                showMessage('ðŸ“‹ Nenhuma venda registrada ainda', 'info');
                return;
            }
            const totalVendas = db.saidas.reduce((sum, s) => {
                const p = db.produtos.find(x => x.id === s.produto_id);
                return sum + (p ? p.preco_venda * s.quantidade : 0);
            }, 0);
            showMessage(`ðŸ“‹ ${db.saidas.length} vendas registradas | Total: R$ ${totalVendas.toFixed(2)}`, 'info');
        }

        function atualizarStatus() {
            document.getElementById('statusSetores').textContent = `<strong>Setores cadastrados:</strong> ${db.setores.length}`;
            document.getElementById('statusProdutos').textContent = `<strong>Produtos cadastrados:</strong> ${db.produtos.length}`;
            document.getElementById('statusVendas').textContent = `<strong>Vendas realizadas:</strong> ${db.saidas.length}`;
        }

        // Limpar dados e recarregar (para desenvolvimento)
        function resetarDados() {
            if (confirm('Tem certeza que deseja RESETAR todos os dados? Esta aÃ§Ã£o nÃ£o pode ser desfeita.')) {
                localStorage.removeItem('amgestao_db'); location.reload();
            }
        }
    </script>
</body>
</html>
