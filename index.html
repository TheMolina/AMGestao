<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>GestÃ£o de ComÃ©rcio - Sistema de Caixa</title>
    <style>
        /* Reset e tipografia */
        * { box-sizing: border-box; }
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background: #f5f5f4;
            color: #35231b;
        }

        /* Paleta limpa */
        :root{
            --brown-900: #4a2e23;
            --brown-700: #6b3e2d;
            --muted: #7a6a63;
            --bg: #fffdfb;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 10px;
            min-height: 88vh;
            box-shadow: 0 8px 30px rgba(30,20,15,0.06);
            overflow: hidden;
        }

        /* Topbar simples */
        .topbar {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 18px;
            background: var(--brown-900);
            color:#fff;
        }
        .topbar .title { font-size:16px; font-weight:600; }
        .topbar .actions { display:flex; gap:8px; align-items:center; }

        .search { padding:8px 10px; border-radius:6px; border:none; min-width:260px; }

        /* Layout */
        .layout { display:grid; grid-template-columns: 1fr 420px; gap:0; min-height: calc(100vh - 64px); }
        @media (max-width:1000px) { .layout { grid-template-columns: 1fr; } }

        /* Painel esquerdo */
        .panel-left { padding:18px; border-right:1px solid #efe7e3; background:var(--bg); }
        .section { margin-bottom:18px; }
        .section h2 { margin:0 0 8px 0; font-size:16px; color:var(--brown-900); }

        .flex-row { display:flex; gap:8px; align-items:center; }
        .btn { background:var(--brown-700); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
        .btn.ghost { background:transparent; border:1px solid #efe7e3; color:var(--brown-700); }
        .btn.small { padding:6px 8px; font-size:13px; }

        .product-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:12px; margin-top:12px; }
        .product-card { background:#fff; border:1px solid #f0e6e2; border-radius:8px; padding:12px; display:flex; flex-direction:column; gap:8px; min-height:110px; }
        .product-name { font-weight:600; color:var(--brown-900); }
        .product-meta { color:var(--muted); font-size:13px; }

        input[type="text"], input[type="number"], select { padding:8px 10px; border:1px solid #eee; border-radius:6px; background:#fff; }

        /* Painel direito */
        .panel-right { padding:18px; background:#fff; display:flex; flex-direction:column; justify-content:space-between; }
        .cart-list { margin-top:12px; overflow:auto; max-height:60vh; }
        .totals { padding:12px; border-top:1px dashed #f0e6e2; display:flex; justify-content:space-between; align-items:center; margin-top:12px; }
        .total-amount { font-size:20px; font-weight:700; color:var(--brown-900); }

        .status-bar { padding:8px 18px; background:#faf7f5; border-top:1px solid #f0e6e2; display:flex; gap:12px; color:var(--muted); font-size:13px; align-items:center; }
        .empty-state { color:var(--muted); padding:10px 6px; }

        table { width:100%; border-collapse:collapse; }
        th, td { padding:8px 6px; border-bottom:1px solid #f3efec; text-align:left; }
        .small-input { width:90px; padding:6px; border-radius:6px; border:1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="title">ðŸ“¦ GestÃ£o de ComÃ©rcio â€” Caixa</div>
            <div class="actions">
                <input id="globalSearch" class="search" placeholder="Pesquisar produto, cÃ³digo..." />
                <button class="btn" onclick="criarSetor()">âž• Setor</button>
                <button class="btn ghost" onclick="document.getElementById('formProduto').scrollIntoView()">âž• Produto</button>
            </div>
        </div>

        <div class="status-bar">
            <div id="statusSetores">Setores cadastrados: 0</div>
            <div id="statusProdutos">Produtos cadastrados: 0</div>
            <div id="statusVendas">Vendas realizadas: 0</div>
        </div>

        <div class="layout">
            <div class="panel-left">
                <div class="section">
                    <h2>Setores</h2>
                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                        <button class="btn" onclick="criarSetor()">âž• Novo Setor</button>
                        <div style="flex:1"></div>
                    </div>
                    <div id="setoresContainer" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
                </div>

                <div class="section" id="formProduto">
                    <h2>Cadastro de Produto</h2>
                    <form onsubmit="criarProduto(event)" style="display:grid;grid-template-columns:1fr 1fr; gap:8px;align-items:end;">
                        <div style="grid-column:1/3">
                            <label>Nome</label><br/>
                            <input id="produtoNome" type="text" required />
                        </div>
                        <div>
                            <label>CÃ³digo de Barras</label><br/>
                            <input id="produtoCodigo" type="text" />
                        </div>
                        <div>
                            <label>Setor</label><br/>
                            <select id="setorProduto"></select>
                        </div>
                        <div>
                            <label>PreÃ§o de Compra (R$)</label><br/>
                            <input id="produtoPrecoCompra" type="number" step="0.01" min="0" required />
                        </div>
                        <div>
                            <label>PreÃ§o de Venda (R$)</label><br/>
                            <input id="produtoPrecoVenda" type="number" step="0.01" min="0" required />
                        </div>
                        <div>
                            <label>Quantidade em Estoque</label><br/>
                            <input id="produtoQuantidade" type="number" step="1" min="0" value="0" required />
                        </div>
                        <div>
                            <label>Tipo de venda</label><br/>
                            <select id="produtoTipoVenda">
                                <option value="unidade">Unidade</option>
                                <option value="peso">Peso (kg)</option>
                            </select>
                        </div>
                        <div>
                            <label>Peso por unidade (kg) â€” opcional</label><br/>
                            <input id="produtoPesoUnidade" type="number" step="0.001" min="0" placeholder="ex: 0.250" />
                        </div>
                        <div style="grid-column:1/3;text-align:right;">
                            <button type="submit" class="btn">Cadastrar Produto</button>
                        </div>
                    </form>
                </div>

                <div class="section">
                    <h2>Produtos</h2>
                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                        <input id="produtoBusca" class="search" placeholder="Pesquisar por nome, cÃ³digo ou GTIN" />
                        <button class="btn small" onclick="filtrarProdutos()">Pesquisar</button>
                        <select id="setorFiltro" style="padding:8px;border-radius:6px;border:1px solid #efe7e3;background:#fff;">
                            <option value="">Todos os setores</option>
                        </select>
                    </div>

                    <div id="productGrid" class="product-grid">
                        <!-- cards preenchidos por renderProdutos() -->
                    </div>
                </div>
            </div>

            <div class="panel-right">
                <div>
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:600;color:var(--brown-900)">Venda atual</div>
                            <div style="font-size:13px;color:var(--muted)">Adicione itens Ã  venda</div>
                        </div>
                        <div>
                            <input id="vendaBusca" class="search" placeholder="Buscar item..." style="min-width:200px;" />
                        </div>
                    </div>

                    <div style="margin-top:12px;display:flex;gap:8px;align-items:end;">
                        <div style="flex:1">
                            <label>Produto</label><br/>
                            <select id="vendaProdutoSelect" style="width:100%;padding:8px;border-radius:6px;border:1px solid #eee;"></select>
                        </div>
                        <div>
                            <label>Quantidade / Peso</label><br/>
                            <input id="vendaQtd" type="number" step="any" min="0.001" class="small-input" placeholder="Qtd ou Kg" />
                        </div>
                        <div>
                            <button class="btn" style="height:40px" onclick="scanVenda()">Adicionar</button>
                        </div>
                    </div>

                    <div id="vendaContainer" class="cart-list"></div>
                </div>

                <div>
                    <div class="totals">
                        <div style="color:var(--muted)">Total</div>
                        <div class="total-amount" id="totalAmount">R$ 0,00</div>
                    </div>

                    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
                        <button class="btn ghost" onclick="resetarDados()">Limpar</button>
                        <button class="btn" style="background:var(--brown-900);color:#fff;" onclick="finalizarVenda()">Finalizar venda</button>
                    </div>
                </div>
            </div>
        </div>
     </div>

    <script>
        // Database em memÃ³ria (defaults)
        const db = {
            setores: [],
            produtos: [],
            saidas: [],
            nextSetor: 1,
            nextProduto: 1,
            vendaLista: []
        };

        // Carregar dados do localStorage (se existir)
        function carregarDados() {
            const saved = localStorage.getItem('amgestao_db');
            if (saved) {
                const parsed = JSON.parse(saved);
                // mesclar para manter referÃªncias de db
                db.setores = parsed.setores || [];
                db.produtos = parsed.produtos || [];
                db.saidas = parsed.saidas || [];
                db.nextSetor = parsed.nextSetor || (db.setores.length ? Math.max(...db.setores.map(s=>s.id))+1 : 1);
                db.nextProduto = parsed.nextProduto || (db.produtos.length ? Math.max(...db.produtos.map(p=>p.id))+1 : 1);
                db.vendaLista = parsed.vendaLista || [];
            }
        }

        // Salvar dados no localStorage
        function salvarDados() {
            localStorage.setItem('amgestao_db', JSON.stringify(db));
        }

        window.onload = function() {
            carregarDados();
            renderSetores();
            renderProdutos();
            renderVenda();
            atualizarStatus();
        };

        function showMessage(msg, type = 'info') { console.log(`[${type}] ${msg}`); }

        function renderSetores() {
            const container = document.getElementById('setoresContainer');
            const select = document.getElementById('setorProduto');
            const filtro = document.getElementById('setorFiltro');

            if (!container) return;
            container.innerHTML = '';

            if (db.setores.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum setor cadastrado. Clique em "âž• Novo Setor" para adicionar.</div>';
                if (select) select.innerHTML = '<option value="">â€” Selecione um setor â€”</option>';
                if (filtro) filtro.innerHTML = '<option value="">Todos os setores</option>';
                atualizarStatus();
                return;
            }

            let html = '';
            for (const s of db.setores) {
                const produtosCount = db.produtos.filter(p => p.setor_id === s.id).length;
                html += `
                    <div style="border:1px solid #f0e6e2;padding:8px;border-radius:8px;background:#fff;min-width:140px;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <strong>${s.nome}</strong>
                            <small style="color:#666;margin-left:6px;">(${produtosCount})</small>
                        </div>
                        <div style="margin-top:8px;display:flex;gap:6px;">
                            <a href="setor.html?setor_id=${s.id}" target="_blank" style="text-decoration:none;">
                                <button type="button" class="btn small">Abrir</button>
                            </a>
                            <button type="button" class="btn ghost small" onclick="excluirSetor(${s.id})" style="background:#dc3545;color:#fff;border:none;">Excluir</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;

            if (select) {
                select.innerHTML = '<option value="">â€” Selecione um setor â€”</option>' + db.setores.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');
            }
            if (filtro) {
                filtro.innerHTML = '<option value="">Todos os setores</option>' + db.setores.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');
            }
            atualizarStatus();
        }

        function excluirSetor(setorId) {
            const setor = db.setores.find(s => s.id === setorId);
            if (!setor) { showMessage('Setor nÃ£o encontrado.', 'error'); return; }

            const produtosNoSetor = db.produtos.filter(p => p.setor_id === setorId);
            if (produtosNoSetor.length > 0) {
                const confirmMsg = `O setor "${setor.nome}" possui ${produtosNoSetor.length} produto(s). Ao excluir, os produtos ficarÃ£o sem setor. Deseja continuar?`;
                if (!confirm(confirmMsg)) return;
                produtosNoSetor.forEach(p => { p.setor_id = null; });
            }

            db.setores = db.setores.filter(s => s.id !== setorId);
            salvarDados();
            showMessage('Setor removido.', 'success');
            renderSetores();
            renderProdutos();
        }

        function renderProdutos() {
            const grid = document.getElementById('productGrid');
            const selectVenda = document.getElementById('vendaProdutoSelect');
            const selectCadastroSetor = document.getElementById('setorProduto');
            const setorFiltro = document.getElementById('setorFiltro');
            const busca = document.getElementById('produtoBusca');

            if (selectVenda) {
                selectVenda.innerHTML = '<option value="">â€” Selecione um produto â€”</option>' + db.produtos.map(p => {
                    return `<option value="${p.id}">${p.nome} â€” R$ ${Number(p.preco_venda).toFixed(2)} â€” ${p.vendido_por === 'peso' ? 'kg' : 'un'}</option>`;
                }).join('');
            }
            if (selectCadastroSetor) {
                selectCadastroSetor.innerHTML = '<option value="">â€” Selecione um setor â€”</option>' + db.setores.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');
            }
            if (setorFiltro) {
                setorFiltro.innerHTML = '<option value="">Todos os setores</option>' + db.setores.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');
            }

            if (!grid) return;
            grid.innerHTML = '';
            const termo = (busca && busca.value) ? busca.value.toLowerCase() : '';
            const filtroSetor = setorFiltro ? setorFiltro.value : '';

            const produtosVisiveis = db.produtos.filter(p => {
                if (filtroSetor && String(p.setor_id) !== String(filtroSetor)) return false;
                if (!termo) return true;
                return (p.nome || '').toLowerCase().includes(termo) || (p.codigo_barras || '').includes(termo);
            });

            if (produtosVisiveis.length === 0) {
                grid.innerHTML = '<div class="empty-state">Nenhum produto encontrado.</div>';
                atualizarStatus();
                return;
            }

            for (const p of produtosVisiveis) {
                grid.innerHTML += `
                    <div class="product-card">
                        <div class="product-name">${p.nome}</div>
                        <div class="product-meta">R$ ${Number(p.preco_venda || 0).toFixed(2)} â€¢ ${p.vendido_por === 'peso' ? 'kg' : 'un'} â€¢ estoque: ${p.quantidade ?? 0}</div>
                        <div class="product-meta">${p.codigo_barras || ''}</div>
                        <div class="actions" style="margin-top:auto;display:flex;gap:8px;">
                            <button class="btn small" onclick="abrirProdutoParaVenda(${p.id})">Adicionar</button>
                            <button class="btn ghost small" onclick="editarProduto(${p.id})">Editar</button>
                        </div>
                    </div>
                `;
            }
            atualizarStatus();
        }

        function criarSetor() {
            const nome = prompt('Nome do setor:');
            if (!nome) return;
            const novoSetor = { id: db.nextSetor++, nome };
            db.setores.push(novoSetor);
            salvarDados();
            renderSetores();
            showMessage(`Setor "${nome}" criado.`, 'success');
        }

        function criarProduto(event) {
            if (event && event.preventDefault) event.preventDefault();
            const nome = (document.getElementById('produtoNome') && document.getElementById('produtoNome').value.trim()) || '';
            if (!nome) { showMessage('Informe nome do produto', 'error'); return; }
            const codigo = document.getElementById('produtoCodigo').value.trim();
            const setorId = Number(document.getElementById('setorProduto').value) || null;
            const precoCompra = parseFloat(document.getElementById('produtoPrecoCompra').value) || 0;
            const precoVenda = parseFloat(document.getElementById('produtoPrecoVenda').value) || 0;
            const quantidade = parseFloat(document.getElementById('produtoQuantidade').value) || 0;
            const vendido_por = document.getElementById('produtoTipoVenda').value || 'unidade';
            const peso_unidade = parseFloat(document.getElementById('produtoPesoUnidade').value) || null;

            const produto = {
                id: db.nextProduto++,
                nome,
                codigo_barras: codigo,
                setor_id: setorId,
                preco_compra: precoCompra,
                preco_venda: precoVenda,
                quantidade,
                vendido_por: vendido_por === 'peso' ? 'peso' : 'unidade',
                peso_unidade: peso_unidade > 0 ? peso_unidade : null
            };
            db.produtos.push(produto);
            salvarDados();
            showMessage('Produto cadastrado.', 'success');
            document.getElementById('produtoNome').value = '';
            document.getElementById('produtoCodigo').value = '';
            document.getElementById('produtoPrecoCompra').value = '';
            document.getElementById('produtoPrecoVenda').value = '';
            document.getElementById('produtoQuantidade').value = 0;
            document.getElementById('produtoPesoUnidade').value = '';
            renderSetores();
            renderProdutos();
        }

        function abrirProdutoParaVenda(produtoId) {
            const sel = document.getElementById('vendaProdutoSelect');
            if (sel) { sel.value = produtoId; document.getElementById('vendaQtd').focus(); }
        }

        function editarProduto(produtoId) {
            const p = db.produtos.find(x => x.id === produtoId);
            if (!p) return alert('Produto nÃ£o encontrado');
            document.getElementById('produtoNome').value = p.nome || '';
            document.getElementById('produtoCodigo').value = p.codigo_barras || '';
            document.getElementById('setorProduto').value = p.setor_id || '';
            document.getElementById('produtoPrecoCompra').value = p.preco_compra || 0;
            document.getElementById('produtoPrecoVenda').value = p.preco_venda || 0;
            document.getElementById('produtoQuantidade').value = p.quantidade || 0;
            document.getElementById('produtoTipoVenda').value = p.vendido_por || 'unidade';
            document.getElementById('produtoPesoUnidade').value = p.peso_unidade || '';
            db.produtos = db.produtos.filter(x => x.id !== produtoId);
            salvarDados();
            renderProdutos();
        }

        function scanVenda() {
            const sel = document.getElementById('vendaProdutoSelect');
            const produtoId = Number(sel.value);
            if (!produtoId) { showMessage('Selecione um produto', 'error'); return; }
            const produto = db.produtos.find(p => p.id === produtoId);
            if (!produto) { showMessage('Produto nÃ£o encontrado', 'error'); return; }

            const input = document.getElementById('vendaQtd');
            const valor = parseFloat(input.value);
            if (!valor || valor <= 0) { showMessage('Informe quantidade ou peso vÃ¡lido', 'error'); return; }

            let quantidade = 0;
            let peso = null;
            if (produto.vendido_por === 'peso') {
                peso = valor;
            } else {
                quantidade = valor;
            }

            db.vendaLista.push({
                produtoId: produto.id,
                nome: produto.nome,
                preco_venda: produto.preco_venda,
                vendido_por: produto.vendido_por,
                quantidade: quantidade,
                peso: peso
            });

            if (produto.vendido_por === 'unidade') {
                produto.quantidade = Math.max(0, (produto.quantidade || 0) - quantidade);
            } else if (produto.vendido_por === 'peso' && produto.peso_unidade) {
                if (produto.quantidade && produto.peso_unidade > 0) {
                    const unidades = Math.round(peso / produto.peso_unidade);
                    produto.quantidade = Math.max(0, produto.quantidade - unidades);
                }
            }

            salvarDados();
            input.value = '';
            renderVenda();
            renderProdutos();
        }

        function removerVenda(index) {
            if (index < 0 || index >= db.vendaLista.length) return;
            const item = db.vendaLista[index];
            const produto = db.produtos.find(p => p.id === item.produtoId);
            if (produto) {
                if (item.vendido_por === 'unidade') {
                    produto.quantidade = (produto.quantidade || 0) + (item.quantidade || 0);
                } else if (item.vendido_por === 'peso' && produto.peso_unidade && produto.quantidade !== undefined) {
                    const unidades = item.peso && produto.peso_unidade ? Math.round(item.peso / produto.peso_unidade) : 0;
                    produto.quantidade = (produto.quantidade || 0) + unidades;
                }
            }
            db.vendaLista.splice(index, 1);
            salvarDados();
            renderVenda();
            renderProdutos();
        }

        function renderVenda() {
            const container = document.getElementById('vendaContainer');
            if (!container) return;
            if (!db.vendaLista || db.vendaLista.length === 0) {
                container.innerHTML = '<div class="empty-state">Carrinho vazio.</div>';
                atualizarStatus();
                return;
            }
            let html = '<table><thead><tr><th>Produto</th><th>Tipo</th><th>Quantidade / Peso</th><th>PreÃ§o Unit.</th><th>Total</th><th></th></tr></thead><tbody>';
            let soma = 0;
            db.vendaLista.forEach((it, idx) => {
                const total = it.vendido_por === 'peso' ? (it.preco_venda * (it.peso || 0)) : (it.preco_venda * (it.quantidade || 0));
                soma += total;
                html += `<tr>
                    <td>${it.nome}</td>
                    <td>${it.vendido_por === 'peso' ? 'Kg' : 'Un'}</td>
                    <td>${it.vendido_por === 'peso' ? (it.peso || 0) + ' kg' : (it.quantidade || 0)}</td>
                    <td>R$ ${Number(it.preco_venda).toFixed(2)}</td>
                    <td>R$ ${Number(total).toFixed(2)}</td>
                    <td><button onclick="removerVenda(${idx})">Remover</button></td>
                </tr>`;
            });
            html += `</tbody></table><div style="text-align:right;margin-top:8px;"><strong>Total: R$ ${soma.toFixed(2)}</strong> <button onclick="finalizarVenda()" style="margin-left:12px;" class="btn">Finalizar Venda</button></div>`;
            container.innerHTML = html;
            document.getElementById('totalAmount').textContent = `R$ ${soma.toFixed(2)}`;
            atualizarStatus();
        }

        function finalizarVenda() {
            if (db.vendaLista.length === 0) {
                showMessage('Nenhum produto na venda', 'error');
                return;
            }

            for (const item of db.vendaLista) {
                db.saidas.push({
                    id: db.saidas.length + 1,
                    produto_id: item.produtoId,
                    quantidade: item.quantidade || item.peso || 0,
                    data: new Date().toISOString()
                });
            }

            const total = db.vendaLista.reduce((sum, item) => sum + (item.preco_venda * (item.vendido_por === 'peso' ? (item.peso || 0) : (item.quantidade || 0))), 0);
            showMessage(`Venda de R$ ${total.toFixed(2)} registrada.`, 'success');

            db.vendaLista = [];
            salvarDados();
            renderVenda();
            atualizarStatus();
        }

        function calcularLucro() {
            let totalLucro = 0;
            for (const saida of db.saidas) {
                const produto = db.produtos.find(p => p.id === saida.produto_id);
                if (produto) {
                    const lucroUnitario = (produto.preco_venda || 0) - (produto.preco_compra || 0);
                    totalLucro += lucroUnitario * (saida.quantidade || 0);
                }
            }
            showMessage(`Lucro Total: R$ ${totalLucro.toFixed(2)}`, 'info');
        }

        function relatorioVendas() {
            if (db.saidas.length === 0) {
                showMessage('Nenhuma venda registrada ainda', 'info');
                return;
            }
            const totalVendas = db.saidas.reduce((sum, s) => {
                const p = db.produtos.find(x => x.id === s.produto_id);
                return sum + (p ? (p.preco_venda || 0) * (s.quantidade || 0) : 0);
            }, 0);
            showMessage(`${db.saidas.length} registros | Total: R$ ${totalVendas.toFixed(2)}`, 'info');
        }

        function atualizarStatus() {
            const elSet = document.getElementById('statusSetores');
            const elProd = document.getElementById('statusProdutos');
            const elVendas = document.getElementById('statusVendas');
            if (elSet) elSet.textContent = `Setores cadastrados: ${db.setores.length}`;
            if (elProd) elProd.textContent = `Produtos cadastrados: ${db.produtos.length}`;
            if (elVendas) elVendas.textContent = `Vendas realizadas: ${db.saidas.length}`;
        }

        function resetarDados() {
            if (confirm('Tem certeza que deseja RESETAR todos os dados? Esta aÃ§Ã£o nÃ£o pode ser desfeita.')) {
                localStorage.removeItem('amgestao_db'); location.reload();
            }
        }

        function filtrarProdutos() { renderProdutos(); }
    </script>
</body>
</html>