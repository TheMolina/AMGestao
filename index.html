<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Com√©rcio - Sistema de Caixa</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }

        .container {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            min-height: 100vh;
        }

        h1 {
            color: #333;
            margin: 0 0 24px 0;
            border-bottom: 3px solid #007bff;
            padding-bottom: 12px;
        }

        h2 {
            color: #555;
            margin: 20px 0 12px 0;
            font-size: 18px;
        }

        section {
            background: #f9f9f9;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        button {
            cursor: pointer;
            padding: 10px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        button:active {
            background: #004085;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        form > div:last-child {
            grid-column: 1 / -1;
            margin-top: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        thead {
            background: #f0f0f0;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        th {
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .setor-box {
            display: inline-block;
            padding: 8px 12px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 6px;
            margin-right: 8px;
            margin-bottom: 8px;
            color: #007bff;
            font-weight: 500;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .status-message {
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
            text-align: center;
        }

        .status-info {
            background: #e7f3ff;
            color: #004085;
            border: 1px solid #b3d9ff;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Gest√£o de Com√©rcio ‚Äî Caixa R√°pido</h1>

        <div id="message"></div>

        <section>
            <div class="flex-between">
                <h2 style="margin:0;">Setores</h2>
                <div>
                    <button onclick="criarSetor()">‚ûï Novo Setor</button>
                </div>
            </div>
             <div id="setoresContainer" style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
             </div>
         </section>

        <section>
            <h2>üìù Cadastro de Produto</h2>
            <form onsubmit="criarProduto(event)" style="margin-top: 12px;">
                <div>
                    <label>Nome</label><br>
                    <input id="produtoNome" required />
                </div>
                <div>
                    <label>C√≥digo de Barras</label><br>
                    <input id="produtoCodigo" />
                </div>
                <div>
                    <label>Setor</label><br>
                    <select id="setorProduto"></select>
                </div>
                <div>
                    <label>Pre√ßo de Compra (R$)</label><br>
                    <input id="produtoPrecoCompra" type="number" step="0.01" min="0" required />
                </div>
                <div>
                    <label>Pre√ßo de Venda (R$)</label><br>
                    <input id="produtoPrecoVenda" type="number" step="0.01" min="0" required />
                </div>
                <div>
                    <label>Quantidade em Estoque</label><br>
                    <input id="produtoQuantidade" type="number" step="1" min="0" value="0" required />
                </div>
                <div>
                    <label>Tipo de venda</label><br>
                    <select id="produtoTipoVenda">
                        <option value="unidade">Unidade</option>
                        <option value="peso">Peso (kg)</option>
                    </select>
                </div>
                <div>
                    <label>Peso por unidade (kg) ‚Äî opcional</label><br>
                    <input id="produtoPesoUnidade" type="number" step="0.001" min="0" placeholder="ex: 0.250" />
                </div>
                <div style="grid-column: 1 / -1; margin-top:8px;">
                    <button type="submit" class="success">Cadastrar Produto</button>
                </div>
            </form>
        </section>

        <section>
            <h2>üí∞ Caixa / Vendas</h2>
            <div style="margin-top: 12px;">
                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                    <div>
                        <label>Produto</label><br>
                        <select id="vendaProdutoSelect" style="min-width:260px;"></select>
                    </div>
                    <div>
                        <label>Quantidade / Peso</label><br>
                        <input id="vendaQtd" type="number" step="any" min="0.001" placeholder="Qtd (un) ou Kg" />
                    </div>
                    <div style="align-self:end;">
                        <button onclick="scanVenda()">Adicionar</button>
                    </div>
                </div>
            </div>
             
             <div id="vendaContainer" style="margin-top: 16px;">
             </div>
         </section>

        <section>
            <h2>üìä Relat√≥rio R√°pido</h2>
            <div class="button-group">
                <button onclick="calcularLucro()">üíπ Calcular Lucro</button>
                <button onclick="relatorioVendas()">üìã Relat√≥rio de Vendas</button>
            </div>
        </section>

        <section style="background: #e7f3ff; border: 1px solid #b3d9ff; margin-top: 24px;">
            <h3 style="margin-top: 0;">‚ÑπÔ∏è Status do Sistema</h3>
            <p><strong>Status:</strong> ‚úÖ Online (Aplica√ß√£o Local)</p>
            <p id="statusSetores"><strong>Setores cadastrados:</strong> 0</p>
            <p id="statusProdutos"><strong>Produtos cadastrados:</strong> 0</p>
            <p id="statusVendas"><strong>Vendas realizadas:</strong> 0</p>
        </section>
    </div>

    <script>
        // Database em mem√≥ria
        const db = {
            setores: [],
            produtos: [],
            saidas: [],
            nextSetor: 1,
            nextProduto: 1,
             vendaLista: []
         };

        // Salvar dados no localStorage
        function salvarDados() {
            localStorage.setItem('amgestao_db', JSON.stringify(db));
        }

        // Carregar dados do localStorage
        function carregarDados() {
            const saved = localStorage.getItem('amgestao_db');
            if (saved) {
                Object.assign(db, JSON.parse(saved));
            }
        }

        // Inicializar na carga
        window.onload = function() {
            carregarDados();
            renderSetores();
            renderProdutos();
            renderVenda();
            atualizarStatus();
        };

        function showMessage(msg, type = 'info') {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = msg;
            msgDiv.className = `status-message status-${type}`;
            msgDiv.style.display = 'block';
            setTimeout(() => msgDiv.style.display = 'none', 4000);
        }

        function renderSetores() {
            const container = document.getElementById('setoresContainer');
            const select = document.getElementById('setorProduto');

            container.innerHTML = '';
            if (!select) {
                // se o formul√°rio ainda n√£o tem o select, apenas ignore
            }
            if (db.setores.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum setor cadastrado. Clique em "‚ûï Novo Setor" para adicionar.</div>';
                if (select) select.innerHTML = '<option value="">‚Äî Selecione um setor ‚Äî</option>';
                atualizarStatus();
                return;
            }

            let html = '';
            for (const s of db.setores) {
                const produtosCount = db.produtos.filter(p => p.setor_id === s.id).length;
                html += `
                    <div class="setor-box">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <strong>${s.nome}</strong>
                            <small style="color:#666;margin-left:6px;">(${produtosCount})</small>
                        </div>
                        <div style="margin-top:8px;display:flex;gap:6px;">
                            <a href="setor.html?setor_id=${s.id}" target="_blank" style="text-decoration:none;">
                                <button type="button">Abrir produtos</button>
                            </a>
                            <button type="button" style="background:#dc3545;border:none;color:#fff;padding:8px 10px;border-radius:4px;" onclick="excluirSetor(${s.id})">Excluir</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;

            if (select) {
                select.innerHTML = '<option value="">‚Äî Selecione um setor ‚Äî</option>' + db.setores.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');
            }
            atualizarStatus();
        }

        function excluirSetor(setorId) {
            const setor = db.setores.find(s => s.id === setorId);
            if (!setor) { showMessage('Setor n√£o encontrado.', 'error'); return; }

            const produtosNoSetor = db.produtos.filter(p => p.setor_id === setorId);
            if (produtosNoSetor.length > 0) {
                const confirmMsg = `O setor "${setor.nome}" possui ${produtosNoSetor.length} produto(s). Ao excluir, os produtos ficar√£o sem setor. Deseja continuar?`;
                if (!confirm(confirmMsg)) return;
                // desassocia produtos (mant√©m produtos)
                produtosNoSetor.forEach(p => { p.setor_id = null; });
            }

            db.setores = db.setores.filter(s => s.id !== setorId);
            salvarDados();
            showMessage('Setor removido.', 'success');
            renderSetores();
            renderProdutos();
        }

        function renderProdutos() {
            const tbody = document.getElementById('produtosTableBody');
            // se n√£o existir tabela detalhada, apenas atualiza selects
            const selectVenda = document.getElementById('vendaProdutoSelect');
            const selectCadastroSetor = document.getElementById('setorProduto');

            if (selectVenda) {
                selectVenda.innerHTML = '<option value="">‚Äî Selecione um produto ‚Äî</option>' + db.produtos.map(p => {
                    return `<option value="${p.id}">${p.nome} ‚Äî R$ ${Number(p.preco_venda).toFixed(2)} ‚Äî ${p.vendido_por === 'peso' ? 'kg' : 'un'}</option>`;
                }).join('');
            }

            if (selectCadastroSetor) {
                selectCadastroSetor.innerHTML = '<option value="">‚Äî Selecione um setor ‚Äî</option>' + db.setores.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');
            }

            // atualizar listagem principal de produtos se houver tabela
            if (tbody) {
                tbody.innerHTML = '';
                if (db.produtos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Nenhum produto cadastrado.</td></tr>';
                } else {
                    for (const p of db.produtos) {
                        const setor = db.setores.find(s => s.id === p.setor_id);
                        tbody.innerHTML += `<tr>
                            <td>${p.nome}</td>
                            <td>${p.codigo_barras || ''}</td>
                            <td>R$ ${Number(p.preco_venda).toFixed(2)}</td>
                            <td>${p.quantidade ?? 0}</td>
                            <td>${p.vendido_por === 'peso' ? 'Peso (kg)' : 'Unidade'}</td>
                            <td>${p.peso_unidade ? p.peso_unidade + ' kg' : '-'}</td>
                        </tr>`;
                    }
                }
            }
            atualizarStatus();
        }

        function criarSetor() {
            const nome = prompt('Nome do setor:');
            if (!nome) return;
            
            const novoSetor = { id: db.nextSetor++, nome };
            db.setores.push(novoSetor);
            salvarDados();
            renderSetores();
            showMessage(`‚úÖ Setor "${nome}" criado com sucesso!`, 'success');
        }

        function criarProduto(event) {
            event.preventDefault();
            const nome = document.getElementById('produtoNome').value.trim();
            const codigo = document.getElementById('produtoCodigo').value.trim();
            const setorId = Number(document.getElementById('setorProduto').value) || null;
            const precoCompra = parseFloat(document.getElementById('produtoPrecoCompra').value) || 0;
            const precoVenda = parseFloat(document.getElementById('produtoPrecoVenda').value) || 0;
            const quantidade = parseFloat(document.getElementById('produtoQuantidade').value) || 0;
            const vendido_por = document.getElementById('produtoTipoVenda').value || 'unidade';
            const peso_unidade = parseFloat(document.getElementById('produtoPesoUnidade').value) || null;

            const produto = {
                id: db.nextProduto++,
                nome,
                codigo_barras: codigo,
                setor_id: setorId,
                preco_compra: precoCompra,
                preco_venda: precoVenda,
                quantidade,
                vendido_por: vendido_por === 'peso' ? 'peso' : 'unidade',
                peso_unidade: peso_unidade > 0 ? peso_unidade : null
            };
            db.produtos.push(produto);
            salvarDados();
            showMessage('Produto cadastrado.', 'success');
            // limpar form
            document.getElementById('produtoNome').value = '';
            document.getElementById('produtoCodigo').value = '';
            document.getElementById('produtoPrecoCompra').value = '';
            document.getElementById('produtoPrecoVenda').value = '';
            document.getElementById('produtoQuantidade').value = 0;
            document.getElementById('produtoPesoUnidade').value = '';
            renderSetores();
            renderProdutos();
        }

        function scanVenda() {
            const sel = document.getElementById('vendaProdutoSelect');
            const produtoId = Number(sel.value);
            if (!produtoId) { showMessage('Selecione um produto', 'error'); return; }
            const produto = db.produtos.find(p => p.id === produtoId);
            if (!produto) { showMessage('Produto n√£o encontrado', 'error'); return; }

            const input = document.getElementById('vendaQtd');
            const valor = parseFloat(input.value);
            if (!valor || valor <= 0) { showMessage('Informe quantidade ou peso v√°lido', 'error'); return; }

            // calcular total conforme tipo
            let quantidade = 0;
            let peso = null;
            if (produto.vendido_por === 'peso') {
                peso = valor; // em kg
                // opcionalmente, reduzir estoque por peso usando peso_unidade se estiver em "unidades"
            } else {
                quantidade = valor;
            }

            // adicionar √† lista de venda
            db.vendaLista.push({
                produtoId: produto.id,
                nome: produto.nome,
                preco_venda: produto.preco_venda,
                vendido_por: produto.vendido_por,
                quantidade: quantidade,
                peso: peso
            });

            // decrementar estoque quando aplic√°vel (simples)
            if (produto.vendido_por === 'unidade') {
                produto.quantidade = Math.max(0, (produto.quantidade || 0) - quantidade);
            } else if (produto.vendido_por === 'peso' && produto.peso_unidade) {
                // se estoque for contado por unidades e peso_unidade informado, reduzir por n√∫mero de unidades equivalentes
                // caso contr√°rio, n√£o altera quantidade (sistema simples)
                // Ex.: se peso_unidade = 0.5kg e vender 1.0kg => reduz 2 unidades
                if (produto.quantidade && produto.peso_unidade > 0) {
                    const unidades = Math.round(peso / produto.peso_unidade);
                    produto.quantidade = Math.max(0, produto.quantidade - unidades);
                }
            }

            salvarDados();
            input.value = '';
            renderVenda();
            renderProdutos();
        }

        function removerVenda(index) {
            if (index < 0 || index >= db.vendaLista.length) return;
            // restaurar estoque b√°sico ao remover item (apenas para unidade simples)
            const item = db.vendaLista[index];
            const produto = db.produtos.find(p => p.id === item.produtoId);
            if (produto) {
                if (item.vendido_por === 'unidade') {
                    produto.quantidade = (produto.quantidade || 0) + (item.quantidade || 0);
                } else if (item.vendido_por === 'peso' && produto.peso_unidade && produto.quantidade !== undefined) {
                    const unidades = item.peso && produto.peso_unidade ? Math.round(item.peso / produto.peso_unidade) : 0;
                    produto.quantidade = (produto.quantidade || 0) + unidades;
                }
            }
            db.vendaLista.splice(index, 1);
            salvarDados();
            renderVenda();
            renderProdutos();
        }

        function renderVenda() {
            const container = document.getElementById('vendaContainer');
            if (!db.vendaLista || db.vendaLista.length === 0) {
                container.innerHTML = '<div class="empty-state">Carrinho vazio.</div>';
                atualizarStatus();
                return;
            }
            let html = '<table><thead><tr><th>Produto</th><th>Tipo</th><th>Quantidade / Peso</th><th>Pre√ßo Unit.</th><th>Total</th><th></th></tr></thead><tbody>';
            let soma = 0;
            db.vendaLista.forEach((it, idx) => {
                const total = it.vendido_por === 'peso' ? (it.preco_venda * (it.peso || 0)) : (it.preco_venda * (it.quantidade || 0));
                soma += total;
                html += `<tr>
                    <td>${it.nome}</td>
                    <td>${it.vendido_por === 'peso' ? 'Kg' : 'Un'}</td>
                    <td>${it.vendido_por === 'peso' ? (it.peso || 0) + ' kg' : (it.quantidade || 0)}</td>
                    <td>R$ ${Number(it.preco_venda).toFixed(2)}</td>
                    <td>R$ ${Number(total).toFixed(2)}</td>
                    <td><button onclick="removerVenda(${idx})">Remover</button></td>
                </tr>`;
            });
            html += `</tbody></table><div style="text-align:right;margin-top:8px;"><strong>Total: R$ ${soma.toFixed(2)}</strong> <button onclick="finalizarVenda()" class="success" style="margin-left:12px;">Finalizar Venda</button></div>`;
            container.innerHTML = html;
            atualizarStatus();
        }

        function finalizarVenda() {
            if (db.vendaLista.length === 0) {
                showMessage('‚ùå Nenhum produto na venda', 'error');
                return;
            }

            for (const item of db.vendaLista) {
                const produto = db.produtos.find(p => p.id === item.id);
                if (produto) {
                    if (produto.quantidade < item.quantidade) {
                        showMessage(`‚ùå Quantidade insuficiente de ${produto.nome}`, 'error');
                        return;
                    }
                    produto.quantidade -= item.quantidade;
                    db.saidas.push({
                        id: db.saidas.length + 1,
                        produto_id: item.id,
                        quantidade: item.quantidade,
                        data: new Date().toISOString(),
                        codigo_barras: item.codigo_barras
                    });
                }
            }

            const total = db.vendaLista.reduce((sum, item) => sum + (item.preco_venda * item.quantidade), 0);
            showMessage(`‚úÖ Venda de R$ ${total.toFixed(2)} registrada com sucesso!`, 'success');
            
            db.vendaLista = [];
            salvarDados();
            renderVenda();
            atualizarStatus();
            document.getElementById('codigoVenda').focus();
        }

        function calcularLucro() {
            let totalLucro = 0;
            for (const saida of db.saidas) {
                const produto = db.produtos.find(p => p.id === saida.produto_id);
                if (produto) {
                    const lucroUnitario = produto.preco_venda - produto.preco_compra;
                    totalLucro += lucroUnitario * saida.quantidade;
                }
            }
            showMessage(`üíπ Lucro Total: R$ ${totalLucro.toFixed(2)}`, 'info');
        }

        function relatorioVendas() {
            if (db.saidas.length === 0) {
                showMessage('üìã Nenhuma venda registrada ainda', 'info');
                return;
            }
            const totalVendas = db.saidas.reduce((sum, s) => {
                const p = db.produtos.find(x => x.id === s.produto_id);
                return sum + (p ? p.preco_venda * s.quantidade : 0);
            }, 0);
            showMessage(`üìã ${db.saidas.length} vendas registradas | Total: R$ ${totalVendas.toFixed(2)}`, 'info');
        }

        function atualizarStatus() {
            document.getElementById('statusSetores').textContent = `<strong>Setores cadastrados:</strong> ${db.setores.length}`;
            document.getElementById('statusProdutos').textContent = `<strong>Produtos cadastrados:</strong> ${db.produtos.length}`;
            document.getElementById('statusVendas').textContent = `<strong>Vendas realizadas:</strong> ${db.saidas.length}`;
        }

        // Limpar dados e recarregar (para desenvolvimento)
        function resetarDados() {
            if (confirm('Tem certeza que deseja RESETAR todos os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
                localStorage.removeItem('amgestao_db'); location.reload();
            }
        }
    </script>
</body>
</html>
