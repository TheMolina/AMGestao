<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Produtos do Setor ‚Äî AMGestao</title>
<style>
    /* Reaproveita visual do index */
    * { box-sizing: border-box; }
    :root{
        --brown-900: #4a2e23;
        --brown-700: #6b3e2d;
        --muted: #7a6a63;
        --bg: #fffdfb;
    }
    body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        background: #f5f5f4;
        color: #35231b;
    }
    .container {
        max-width: 1000px;
        margin: 20px auto;
        background: #ffffff;
        border-radius: 10px;
        padding: 18px;
        box-shadow: 0 8px 30px rgba(30,20,15,0.06);
    }
    .topbar {
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:12px 18px;
        background: var(--brown-900);
        color:#fff;
        border-radius:8px;
        margin-bottom:12px;
    }
    .topbar .title { font-size:16px; font-weight:600; }
    a.button {
        display:inline-block;
        padding:8px 12px;
        background:#fff;
        color:var(--brown-900);
        border-radius:6px;
        text-decoration:none;
        font-weight:600;
    }

    table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff;border-radius:6px;overflow:hidden}
    thead{background:#faf7f5;color:var(--muted)}
    th,td{padding:10px;border-bottom:1px solid #f3efec;text-align:left}
    .empty{color:var(--muted);padding:20px;text-align:center}
    .btn { background:var(--brown-700); color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; }
    .btn.ghost { background:transparent; border:1px solid #efe7e3; color:var(--brown-700); }
    .btn-danger{background:#dc3545;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
    .btn-primary{background:#007bff;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
    .small-input{width:120px;padding:6px;border:1px solid #eee;border-radius:6px}
    #message{margin-top:8px;color:green}
    .actions-row{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="title">üìÅ Produtos do Setor</div>
            <div style="display:flex;gap:8px;align-items:center;">
                <a class="button" href="index.html">‚Üê Voltar</a>
            </div>
        </div>

        <h2 id="titulo">Produtos</h2>
        <div id="message"></div>
        <div id="conteudo"></div>
    </div>

<script>
function getQuery(name) {
    const params = new URLSearchParams(location.search);
    return params.get(name);
}

function carregarDB() {
    const saved = localStorage.getItem('amgestao_db');
    return saved ? JSON.parse(saved) : { setores: [], produtos: [], saidas: [], nextSetor:1, nextProduto:1, vendaLista: [] };
}
function salvarDB(db){ localStorage.setItem('amgestao_db', JSON.stringify(db)); }

function showMessage(txt, isError = false) {
    const el = document.getElementById('message');
    el.textContent = txt;
    el.style.color = isError ? 'crimson' : 'green';
    setTimeout(()=> { el.textContent = ''; }, 3000);
}

const setorId = parseInt(getQuery('setor_id'));
let db = carregarDB();
let setor = db.setores.find(s => s.id === setorId);

document.getElementById('titulo').textContent = setor ? `Produtos ‚Äî ${setor.nome}` : 'Produtos ‚Äî Setor n√£o encontrado';

function render() {
    db = carregarDB(); // recarrega
    setor = db.setores.find(s => s.id === setorId);
    const conteudo = document.getElementById('conteudo');
    if (!setor) {
        conteudo.innerHTML = '<div class="empty">Setor n√£o encontrado ou inv√°lido.</div>';
        return;
    }

    const produtos = db.produtos.filter(p => p.setor_id === setor.id);
    if (produtos.length === 0) {
        conteudo.innerHTML = '<div class="empty">Nenhum produto cadastrado neste setor.</div>';
        return;
    }

    let html = '<table><thead><tr><th>Nome</th><th>C√≥digo</th><th>Tipo</th><th>Peso/unid</th><th>Pre√ßo</th><th>Quantidade</th><th>A√ß√µes</th></tr></thead><tbody>';
    for (const p of produtos) {
        html += `<tr id="prod-row-${p.id}">
            <td>${p.nome}</td>
            <td>${p.codigo_barras || ''}</td>
            <td>${p.vendido_por === 'peso' ? 'Peso (kg)' : 'Unidade'}</td>
            <td>${p.peso_unidade ? p.peso_unidade + ' kg' : '-'}</td>
            <td>R$ ${Number(p.preco_venda || 0).toFixed(2)}</td>
            <td><input id="qty-${p.id}" class="small-input" type="number" step="${p.vendido_por === 'peso' ? '0.001' : '1'}" min="0" value="${p.quantidade ?? 0}"></td>
            <td class="actions-row">
                <button class="btn-primary" onclick="salvarQuantidade(${p.id})">Salvar Qtd</button>
                <button class="btn-danger" onclick="excluirProduto(${p.id})">Excluir</button>
                <button class="btn ghost" onclick="abrirEdicao(${p.id})">Editar</button>
            </td>
        </tr>`;
    }
    html += '</tbody></table>';
    conteudo.innerHTML = html;
}

function salvarQuantidade(produtoId) {
    db = carregarDB();
    const p = db.produtos.find(x => x.id === produtoId);
    if (!p) { showMessage('Produto n√£o encontrado.', true); return; }
    const input = document.getElementById(`qty-${produtoId}`);
    if (!input) { showMessage('Campo n√£o encontrado.', true); return; }
    const val = parseFloat(input.value);
    if (isNaN(val) || val < 0) { showMessage('Informe uma quantidade v√°lida.', true); return; }
    p.quantidade = (p.vendido_por === 'peso') ? Number(val) : Math.round(val);
    salvarDB(db);
    showMessage('Quantidade atualizada.');
    render();
}

function excluirProduto(produtoId) {
    db = carregarDB();
    const p = db.produtos.find(x => x.id === produtoId);
    if (!p) { showMessage('Produto n√£o encontrado.', true); return; }
    if (!confirm(`Excluir o produto "${p.nome}"? Esta a√ß√£o n√£o pode ser desfeita.`)) return;
    db.produtos = db.produtos.filter(x => x.id !== produtoId);
    salvarDB(db);
    showMessage('Produto exclu√≠do.');
    render();
}

function abrirEdicao(produtoId) {
    // Preenche formul√°rio no index.html: abrimos index.html e preenchemos via localStorage sinalizando edi√ß√£o
    // Simples: marcar produto para edi√ß√£o no localStorage e abrir index
    db = carregarDB();
    localStorage.setItem('amgestao_edit_produto', String(produtoId));
    window.open('index.html', '_blank');
}

render();
</script>
</body>
</html>